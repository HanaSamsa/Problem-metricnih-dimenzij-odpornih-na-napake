from sage.all import *
from sage.all import graphs
import matplotlib.pyplot as plt

G = graphs.CompleteGraph(5)

# DEFINIRAMO FUNKCIJO, KI IZRAČUNA ftdim(G)

def na_napake_odporna_metricna_dimenzija(G):

    n = G.num_verts()
    razdalje = G.distance_all_pairs()

    p = MixedIntegerLinearProgram(maximization = False)
    x = p.new_variable(binary = True)

    p.set_objective(sum(x[i] for i in G)) # ciljna funkcija

    for u, v in Combinations(G, 2): # dodamo pogoj
        p.add_constraint(sum(x[i] for i in G if razdalje[u].get(i, n) != razdalje[v].get(i, n)) >= 2)

    p.solve()
    na_napake_odporna_razlocujoca_mnozica = [i for i in G if round(p.get_values(x[i])) == 1]

    return len(na_napake_odporna_razlocujoca_mnozica)

# DEFINIRAMO ŠE FUNKCIJO, KI IZRAČUNA METRIČNO DIMENZIJO GRAFA dim(G):

def metricna_dimenzija(G):

    n = G.num_verts()
    razdalje = G.distance_all_pairs()

    p = MixedIntegerLinearProgram(maximization = False)
    x = p.new_variable(binary = True)

    p.set_objective(sum(x[i] for i in G))

    for u, v in Combinations(G, 2):
        p.add_constraint(sum(x[i] for i in G if razdalje[u].get(i, n) != razdalje[v].get(i, n)) >= 1)

    p.solve()
    razlocujoca_mnozica = [i for i in G if round(p.get_values(x[i])) == 1]

    return len(razlocujoca_mnozica)


# DEFINIRAMO FUNKCIJO, KI POIŠČE USTREZNE GRAFE:

def poisci_grafe(ciljna_dim, ciljna_ftdim, st_vozlisc):

    grafi = [] # dodajali bomo ustrezne grafe

    for G in graphs.nauty_geng(f'{st_vozlisc} -c'): # samo povezani grafi
        dim = metricna_dimenzija(G)
        ftdim = na_napake_odporna_metricna_dimenzija(G)
        
        if dim == ciljna_dim and ftdim == ciljna_ftdim:
            sosedi = {v: list(G[v]) for v in G} # sosede potrebujemo za risanje grafov
            grafi.append((G, st_vozlisc, dim, ftdim, sosedi))
            plt.figure(figsize = (6, 6))
            plot(G).show()  # izrišem grafe
            plt.close()
    
    return len(grafi) # vrnemo število ustreznih grafov

# najmanjše možno število vozlišč za ftdim = 5 je 7

# PREIZKUŠANJE NA PRIMERIH

# Preverjamo ustrezne grafe na 7 vozliščih             
# poisci_grafe(2, 5, 7) # 6.57s, dobimo 2 grafa

# Preverjamo ustrezne grafe na 8 vozliščih
# poisci_grafe(2, 5, 8) # 1min24, 65 grafov

# Preverjamo ustrezne grafe na 9 vozliščih
# poisci_grafe(2, 5, 9) # po 30 minutah se koda preneha izvajati

# ugotovimo torej, da se že za ftdim = 5 in 9 vozlišč koda ne izvede v nekem sprejemljivem času --> uberemo drug pristop

# Prej preverimo še za ftdim = 6:
# poisci_grafe(2, 6, 12) # tudi tukaj se koda izvaja več kot pol ure

# Tako bo torej za vse višje ftdim, ker rabimo tudi vedno večje število vozlišč grafa